##### 查询引用次数

```python
# getrefcount() 会创建了一个临时的引用因此结果，会比期望的+1

import sys
a = 10
print(sys.getrefcount(a))
```

##### 结构体

```
python 对象底层都继承 PyObject, 都有结构体 struct_object, 里面的 ob_refcnt 就是引用计数
```



```c
#define PyObject_HEAD       PyObject ob_base ;
#define PyObject_VAR_HEAD       PyVarObject ob_base;
//宏定义，包含上一个、下一个，用于构造双向链表用。(放到refchain链表中时，要用到)
#define _PyObject_HEAD_EXTRA            \
    struct _object *_ob_next;           \
    struct _object *_ob_prev;

typedef struct_object {
    _PyObject_HEAD_EXTRA            // 用于构造双向链表
    Py_ssize_t ob_refcnt;           // 引用计数器
    struct _typeobject *ob_type;    // 数据类型
} PyObject;

typedef struct {
    PyObject ob_base;       // PyObject对象
    Py_ssize_t ob_size; /* Number of items in variable part, 即:元素个数*/
} PyVarObject;
```

##### 增加

```
1. 对象被创建并赋值给某个变量，比如：a = 'ABC'
2. 变量间的相互引用, 比如：b=a
3. 变量作为参数传到函数中, 比如：ref_method(a)，
4. 将对象放到某个容器对象中, 比如：c = [1, a, 'abc']
```

##### 减少

```
1. 变量指向新对象
2. 对象的引用变量被销毁时，比如del a (del a 后再去获取a的引用计数会直接报错)
3. 对象被从容器对象中移除，比如：c.remove(a)
4. 直接将整个容器销毁，比如：del c
5. 当一个变量离开了作用域
```

##### 例如

<img src=".\image\引用计数1.png" alt="引用计数1" style="zoom:30%;" />

```python
pi = 3.14
f = pi
l = [f]
```



