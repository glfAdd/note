### image (镜像)

##### Union File System (UnionFs)

<img src=".\image\镜像分层.png" alt="镜像分层" style="zoom:80%;" />

```
Docker镜像是由文件系统叠加而成。
第二层 root file system (rootfs): base 镜像提供的是最小的Linux发行版(Centos, Debian 等)
第一层 bootfs: 是一个引导文件系统


镜像是一种软件包, 包含运行某个软件所需的代码、运行时库、环境变量和配置文件等, 采用 UnionFs.

1. 联合文件系统, 是一种分层、轻量级并且高性能的文件系统，它支持对文件系统的修改作为一次提交来一层层的叠加，同时可以将不同目录挂载到同一个虚拟文件系统下
2. 不同镜像可以共享一些基础的文件系统层，同时再加上自己独有的改动层，大大提高了存储的效率
	(可以这么来理解，比如你拉取了一个v1版本的nginx , 然后又拉取了一个v2版本的nginx,那么拉取的v2版本的会共享v1中相同的镜像层，只是下载与v1不同的镜像层，这样不仅节省了资源，也节省了时间流量，同时如果你要删除v1版本的话，也只是删除了与v2版本不同的镜像层，不会影响v2的运行)
3. 用户升级镜像时, 一个新的镜像层会被创建。不用替换整个原镜像或者完全重新建立新镜像，只需要添加新层即可
4. 在用户分发镜像的时，也只需要分发被改动的新层内容(增量部分)。







Docker 中使用的 AUFS（AnotherUnionFS）就是一种联合文件系统。 AUFS 支持为每一个成员目录（类似 Git 的分支）设定只读（readonly）、读写（readwrite）和写出（whiteout-able）权限, 同时 AUFS 里有一个类似分层的概念, 对只读权限的分支可以逻辑上进行增量地修改(不影响只读部分的)。

Docker容器是建立在Aufs基础上的，Aufs是一种Union FS， 简单来说就是支持将不同的目录挂载到同一个虚拟文件系统下，并实现一种layer的概念。

Aufs将挂载到同一虚拟文件系统下的多个目录分别设置成read-only，read-write以及whiteout-able权限，对read-only目录只能读，而写操作只能实施在read-write目录中。重点在于，写操作是在read-only上的一种增量操作，不影响read-only目录。

当挂载目录的时候要严格按照各目录之间的这种增量关系，将被增量操作的目录优先于在它基础上增量操作的目录挂载，待所有目录挂载结束了，继续挂载一个read-write目录，如此便形成了一种层次结构。

```

##### 镜像读写

```
1. 一个镜像可以放到另一个镜像的顶部, 下面的镜像称为父镜像, 最底部的镜像称为基础镜像（base image）
2. 


copy on wrte 机制: 当 Docker 第一次启动一个容器时，初始的读写层是空的。当文件系统发生变化时，这些变化都会应用到这一层上。比如，如果想修改一个文件，这个文件首先会从该读写层下面的只读层复制到该读写层。该文件的只读版本依然存在



从一个镜像启动容器时, Docker 会在该镜像的最顶层创建一个读写文件系统层, , 在 Docker 中运行的程序就是在这个读写层中执行, 容器层保存镜像变化的部分, 并不会对镜像本身进行任何修改
容器层以下所有镜像层都是只读的






通常这种机制被称为写时复制（copy on wrte）

每个只读镜像层都是只读的，并且以后永远不会变化。

当创建一个新容器时，Docker 会构建出一个镜像栈，并在栈的最顶端添加一个读写层。

这个读写层再加上其下面的镜像层以及一些配置数据，就构成了一个容器。

容器是可以修改的，它们都有自己的状态，并且是可以启动和停止的。

容器的这种特点加上镜像分层框架（image-layering famework），使我们可以快速构建镜像并运行包含我们自己的应用程序和服务的容器。
docker 从上往下依次查找文件 
```



##### Docker 镜像加载原理

```
Docker的镜像实际上由一层一层的UnionFs文件系统组成bootfs：主要包含 bootloader和 Kernel，bootloader主要是引导加 kernel，Linux刚启动时会加bootfs文件系统，在 Docker镜像的最底层是bootfs，这一层与我们典型的Linux/Unix系统是一样的，包含bootfs加载器和内核，当bootfs加载完成之后整个内核就都在内存中了，此时内存的使用权已由 bootfs转交给内核，此时系统也会卸载bootfs。






```



<img src=".\image\镜像原理.png" alt="镜像原理" style="zoom:80%;" />

##### 参考

- [ ] https://blog.51cto.com/u_14035463/5584314
- [ ] 