```
DML: Select\delete\update\insert\call
DDL: create\drop\alter 
```

##### 概述

```
就是保证主服务器（Master）和从服务器（Slave）的数据是一致性的，向Master插入数据后，Slave会自动从Master把修改的数据同步过来（有一定的延迟），通过这种方式来保证数据的一致性，就是Mysql复制
```

##### 能解决什么问题

```
一、高可用和故障切换
二、负载均衡
三、数据备份
```

##### 主从复制过程

```
1. master服务器将数据的改变记录二进制binlog日志，当master上的数据发生改变时，则将其改变写入二进制日志中；

2. slave服务器会在一定时间间隔内对master二进制日志进行探测其是否发生改变，如果发生改变，则开始一个I/O线程请求master二进制事件

3. 同时主节点为每个I/O线程启动一个dump线程，用于向其发送二进制事件，并保存至从节点本地的中继日志中，从节点将启动SQL线程从中继日志中读取二进制日志，在本地重放，使得其数据和主节点的保持一致，最后I/O线程和SQL线程将进入睡眠状态，等待下一次被唤醒。

解释:
    1. 从库会生成两个线程,一个I/O线程,一个SQL线程;
    2. I/O线程会去请求主库的binlog,并将得到的binlog写到本地的relay-log(中继日志)文件中;
    3. 主库会生成一个log dump线程,用来给从库I/O线程传binlog;
    4. SQL线程,会读取relay log文件中的日志,并解析成sql语句逐一执行;
```

##### 主从复制的形式

```
1. 异步复制（Asynchronous replication）: MySQL默认的复制即是异步的，主库在执行完客户端提交的事务后会立即将结果返给给客户端，并不关心从库是否已经接收并处理，这样就会有一个问题，主如果crash掉了，此时主上已经提交的事务可能并没有传到从上，如果此时，强行将从提升为主，可能导致新主上的数据不完整。

2. 全同步复制（Fully synchronous replication）: 指当主库执行完一个事务，所有的从库都执行了该事务才返回给客户端。因为需要等待所有从库执行完该事务才能返回，影响性能

3. 半同步复制（Semisynchronous replication）: 介于异步复制和全同步复制之间，主库在执行完客户端提交的事务后不是立刻返回给客户端，而是等待至少一个从库接收到并写到relay log中才返回给客户端。相对于异步复制，半同步复制提高了数据的安全性，同时它也造成了一定程度的延迟，这个延迟最少是一个TCP/IP往返的时间。所以，半同步复制最好在低延时的网络中使用。
```

##### 主从复制三种主要实现粒度

```
1、基于语句的复制
在Master上执行的SQL语句，在Slave上执行同样的语句。MySQL默认采用基于语句的复制，效率比较高。一旦发现没法精确复制时，会自动选着基于行的复制

2、基于行的复制
把改变的内容复制到Slave，而不是把命令在Slave上执行一遍。从MySQL5.0开始支持

3、混合类型的复制
默认采用基于语句的复制，一旦发现基于语句的无法精确的复制时，就会采用基于行的复制

相应地，binlog的格式也有三种：STATEMENT，ROW，MIXED。
```

##### 主从复制存在的问题

```
主库宕机后，数据可能丢失
从库只有一个sql Thread，主库写压力大，复制很可能延时


半同步复制---解决数据丢失的问题
异步复制----解决从库复制延迟的问题
```

##### 主从同步延时分析

```
原理:
1. 主库针对写操作，顺序写binlog，从库单线程去主库顺序读binlog，从库取到binlog在本地原样执行，来保证主从数据逻辑上一致。
2. mysql的主从复制都是单线程的操作(写binlog/读binlog/slave执行sql)
3. DML和DDL的IO操作是随机的，不是顺序的，执行成本高
4. master可以并发，Slave SQL线程线程却不可以。

引发原因:
1. 数据库在业务上读写压力太大，硬盘随机IO, 读写binlog带来的性能影响
2. 网络传输延迟。

例如: 
1. slave上的其他查询产生lock争用，由于Slave SQL线程也是单线程的，所以一个DDL卡主了，需要执行10分钟，那么所有之后的DDL和DML会等待这个DDL执行完才会继续执行，这就导致了延时。
2. slave的大型query语句产生了锁等待


解决方案：
1.业务分库。
2.读写分离。
3.服务的基础架构在业务和mysql之间加入memcache或者redis的cache层。降低mysql的读压力。
4.不同业务的mysql物理上放在不同机器，分散压力。
5.使用更加强劲的硬件设备
```



```
级联方式复制: A->B->C

多源复制: 一个从站能有一个以上主站

环形复制
```

